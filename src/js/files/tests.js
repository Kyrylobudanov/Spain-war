(() => {
  const quizRoot = document.getElementById('quizArea');
  const genBtn = document.getElementById('generateBtn');
  const checkBtn = document.getElementById('checkBtn');
  const resetBtn = document.getElementById('resetBtn');

  if (!quizRoot || !genBtn || !checkBtn || !resetBtn) return;

  const BANK_SINGLE = [
    { q: "Який фактор був вирішальним для українців Галичини при вступі до Інтербригад?", choices: ["Протест проти польської політики «пацифікації»", "Бажання отримати іспанське громадянство", "Заклик Організації Українських Націоналістів (ОУН)"], answerIndex: 0 },
    { q: "Чому українці-емігранти з табору УНР підтримали генерала Франко?", choices: ["Вбачали в ньому союзника у боротьбі проти більшовизму", "Франко пообіцяв визнати незалежність України", "Вони були мобілізовані примусово"], answerIndex: 0 },
    { q: "Яка доля спіткала Комуністичну партію Західної України (КПЗУ) у 1938 році?", choices: ["Вона була розпущена Комінтерном через звинувачення у «фашизмі»", "Вона стала правлячою партією в УСРР", "Вона об'єдналася з іспанськими анархістами"], answerIndex: 0 },
    { q: "До складу якого більшого формування входила рота імені Тараса Шевченка?", choices: ["XIII інтербригада ім. Домбровського", "XI інтербригада ім. Тельмана", "Батальйон ім. Лінкольна"], answerIndex: 0 },
    { q: "Хто здійснював командування ротою ім. Шевченка на початковому етапі?", choices: ["Станіслав Томашевич", "Юрій Великанович", "Олександр Родімцев"], answerIndex: 0 },
    { q: "Яка битва стала першим серйозним випробуванням для роти ім. Шевченка?", choices: ["Битва під Брунете", "Оборона Мадрида", "Битва на Харамі"], answerIndex: 0 },
    { q: "Яку функцію виконував Юрій Великанович у роті?", choices: ["Був журналістом, редактором газети та політкомісаром", "Командував танковим взводом", "Був головним лікарем санітарної частини"], answerIndex: 0 },
    { q: "Яким був соціальний склад українських добровольців-республіканців?", choices: ["Робітники-мігранти (шахтарі, металурги) та селяни", "Кадрові офіцери Радянської Армії", "Представники інтелігенції та духовенства"], answerIndex: 0 },
    { q: "Під яким статусом радянські військові перебували в Іспанії?", choices: ["Як «добровольці» та «військові радники» під чужими прізвищами", "Як офіційний експедиційний корпус Червоної Армії", "Як спостерігачі від Ліги Націй"], answerIndex: 0 },
    { q: "Яка доля чекала на більшість радянських «іспанців» після повернення в СРСР?", choices: ["Репресії та підозра у шпигунстві", "Отримання високих посад у партії", "Дозвіл на виїзд за кордон"], answerIndex: 0 },
    { q: "В якому підрозділі служив генерал-хорунжий армії УНР Микола Шинкаренко?", choices: ["Іноземний легіон та «Рекетес»", "Дивізія «Кондор»", "Італійський корпус CTV"], answerIndex: 0 },
    { q: "Чому українців у війську Франко часто записували як «ruso»?", choices: ["Через відсутність України на політичній карті світу", "Іспанці не розрізняли слов'янські мови", "Це була вимога радянського посольства"], answerIndex: 0 },
    { q: "Чим займався Всеволод Марченко у війську націоналістів?", choices: ["Був пілотом бомбардувальної авіації", "Керував артилерійською батареєю", "Займався вербуванням добровольців"], answerIndex: 0 },
    { q: "Яку відповідь отримав лейтенант Бєлинський на прохання створити український підрозділ?", choices: ["Відмову через статус іноземця", "Згоду та фінансування", "Пропозицію очолити іспанську роту"], answerIndex: 0 },
    { q: "Що таке «Рекетес», куди вступали українські офіцери?", choices: ["Військові формування монархістів-карлістів", "Спецпідрозділи фалангістів", "Загони німецьких інструкторів"], answerIndex: 0 },
    { q: "Де продовжили військову службу деякі українці-франкісти після 1941 року?", choices: ["У складі «Блакитної дивізії» на Східному фронті", "У Французькому іноземному легіоні", "В Українській Повстанській Армії"], answerIndex: 0 },
    { q: "Якою була чисельна пропорція українців у війні?", choices: ["Переважна більшість — за Республіку, меншість — за Франко", "Приблизно порівну з обох боків", "Більшість підтримала націоналістів"], answerIndex: 0 },
    { q: "Звідки прибували українські добровольці до роти ім. Шевченка?", choices: ["З Галичини (Польща), Канади та Франції", "Тільки з території УРСР", "Виключно з таборів інтернованих у Німеччині"], answerIndex: 0 },
    { q: "Яку тактику часто застосовували інтербригади, зокрема рота ім. Шевченка?", choices: ["Контратаки та оборона укріплених районів", "Партизанська війна в тилу ворога", "Морські десанти на узбережжя"], answerIndex: 0 },
    { q: "Хто з відомих воєначальників був радником в Іспанії під псевдонімом «Колонель Малино»?", choices: ["Родіон Малиновський", "Семен Тимошенко", "Климент Ворошилов"], answerIndex: 0 }
  ];

  const BANK_MULTI = [
    { q: "Які сили активно підтримували націоналістів (генерала Франко)?", choices: ["Нацистська Німеччина", "Фашистська Італія", "Португалія", "Радянський Союз", "Мексика"], correct: [0, 1, 2] },
    { q: "Які чинники спонукали українців Галичини вступати до Інтербригад?", choices: ["Антифашистські переконання", "Тиск польської влади (пацифікація)", "Робота комуністичних осередків", "Обіцянка іспанської землі", "Наказ уряду УНР"], correct: [0, 1, 2] },
    { q: "Які наслідки мала війна для українців-республіканців?", choices: ["Ув'язнення в таборі Береза Картузька", "Інтернування у французькі табори", "Сталінські репресії", "Масове надання державних нагород Польщі", "Створення автономії в Іспанії"], correct: [0, 1, 2] },
    { q: "Хто з перелічених осіб воював на боці Республіки?", choices: ["Юрій Великанович", "Станіслав Томашевич", "Семен Побережник", "Микола Шинкаренко", "Всеволод Марченко"], correct: [0, 1, 2] },
    { q: "У яких регіонах Іспанії брала участь у боях рота імені Тараса Шевченка?", choices: ["Брунете (біля Мадрида)", "Арагонський фронт", "Річка Ебро", "Гібралтар", "Марокко"], correct: [0, 1, 2] },
    { q: "З яких країн прибували добровольці до української роти?", choices: ["Польща (Галичина)", "Канада", "Франція", "Японія", "Норвегія"], correct: [0, 1, 2] },
    { q: "Які видання висвітлювали діяльність українців-республіканців?", choices: ["Газета «Боротьба»", "Часопис «Домбровчик»", "Бюлетень «Вісті із Західної України»", "Газета «Сурма»", "Журнал «Тризуб»"], correct: [0, 1, 2] },
    { q: "Які військові спеціалісти направлялися з СРСР до Іспанії?", choices: ["Танкісти", "Льотчики", "Військові радники", "Кіннота", "Повітряно-десантні війська"], correct: [0, 1, 2] },
    { q: "Хто з перелічених осіб підтримав націоналістів Франко?", choices: ["Микола Шинкаренко", "Всеволод Марченко", "Володимир Бєлинський", "Ян Барвінський", "Василь Клименко"], correct: [0, 1, 2] },
    { q: "Які мотиви мали українці-франкісти?", choices: ["Захист релігійних цінностей", "Боротьба проти поширення комунізму", "Продовження боротьби 1917-1921 років", "Підтримка СРСР", "Солідарність з польською владою"], correct: [0, 1, 2] },
    { q: "У яких формуваннях служили українці-націоналісти?", choices: ["Іспанський іноземний легіон", "Загони «Рекетес»", "Військово-повітряні сили", "Рота ім. Шевченка", "Батальйон Чапаєва"], correct: [0, 1, 2] },
    { q: "Які факти відомі про діяльність Миколи Шинкаренка в Іспанії?", choices: ["Отримав звання лейтенанта іспанської армії", "Був багаторазово поранений (6 разів)", "Отримав пенсію за військові заслуги", "Очолював розвідку СРСР", "Загинув у 1936 році"], correct: [0, 1, 2] },
    { q: "Які риси були характерні для українців-франкістів?", choices: ["Досвід служби в армії УНР або Білому русі", "Категоричний антикомунізм", "Військова професійність", "Бажання встановити радянську владу", "Підтримка політики Комінтерну"], correct: [0, 1, 2] },
    { q: "Які прізвища українців зафіксовані в архівах франкістів?", choices: ["Гончаренко", "Яремчук", "Клименко", "Бандера", "Великанович"], correct: [0, 1, 2] },
    { q: "Чому українці воювали в Іспанії, не маючи власної держави?", choices: ["Іспанія сприймалася як поле битви між світовими ідеологіями", "Це було продовження внутрішнього українського конфлікту", "Досвід війни планували використати для майбутньої боротьби за Україну", "Це був єдиний спосіб заробити гроші", "Згідно з офіційним наказом уряду УРСР"], correct: [0, 1, 2] },
    { q: "Які країни підтримували Республіку?", choices: ["СРСР", "Мексика", "Франція (негласно через кордон)", "Німеччина", "Італія"], correct: [0, 1, 2] },
    { q: "Які наслідки поразки Республіки були для українців?", choices: ["Заборона комуністичних організацій в Іспанії", "Еміграція вцілілих бійців до Латинської Америки", "Посилення репресій проти ветеранів війни в СРСР", "Масове повернення до Львова без перешкод", "Встановлення українського прапора над Мадридом"], correct: [0, 1, 2] },
    { q: "Які обов'язки виконували політкомісари в інтербригадах?", choices: ["Ідеологічне виховання бійців", "Випуск газет та листівок", "Підтримка бойового духу", "Збір податків з населення", "Планування операцій разом з німцями"], correct: [0, 1, 2] },
    { q: "Які характеристики стосуються руху «Рекетес»?", choices: ["Традиціоналізм і монархізм", "Символіка з червоним беретом", "Гасло «Бог, Батьківщина, Король»", "Атеїстичні погляди", "Підпорядкування Москві"], correct: [0, 1, 2] },
    { q: "Хто з українців згадується як загиблий льотчик-франкіст?", choices: ["Всеволод Марченко", "Костянтин Гончаренко", "Ян Барвінський", "Юрій Великанович", "Семен Побережник"], correct: [0] } // Тут лишаємо одне, але в коді воно спрацює як мульти
  ];

  const BANK_TEXT = [
    { q: "Як називалася єдина українська рота у складі Інтербригад?", answer: ["Шевченка", "імені Тараса Шевченка", "Тараса Шевченка"] },
    { q: "Як називалася газета, яку редагував Юрій Великанович?", answer: ["Боротьба"] },
    { q: "У якому польському концтаборі опинялися добровольці після повернення?", answer: ["Береза Картузька", "Береза-Картузька", "Береза"] },
    { q: "Назвіть прізвище генерала УНР, який воював за Франко.", answer: ["Шинкаренко", "Микола Шинкаренко"] },
    { q: "Як називалася організація західноукраїнських комуністів, ліквідована у 1938 році?", answer: ["КПЗУ", "Компартія Західної України"] },
    { q: "Як називалося монархічне ополчення, куди вступали українські офіцери?", answer: ["Рекетес", "Requetes"] },
    { q: "Назвіть прізвище українського пілота, який загинув за націоналістів.", answer: ["Марченко", "Всеволод Марченко"] },
    { q: "Як в документах франкістів найчастіше записували національність українців?", answer: ["Русо", "Ruso", "Росіяни"] },
    { q: "Хто був першим командиром роти ім. Шевченка (прізвище)?", answer: ["Томашевич", "Станіслав Томашевич"] },
    { q: "Який номер мала Інтербригада, до якої входили українці?", answer: ["13", "XIII", "Тринадцята"] },
    { q: "Назвіть прізвище радянського генерала, що був радником під псевдо Малино.", answer: ["Малиновський", "Родіон Малиновський"] },
    { q: "Яка битва стала бойовим хрещенням для української роти?", answer: ["Брунете", "Під Брунете", "Битва під Брунете"] },
    { q: "Назвіть прізвище офіцера, який писав листа Франко щодо українського легіону.", answer: ["Бєлинський", "Володимир Бєлинський"] },
    { q: "Яка ідеологія об'єднувала українців на боці Франко?", answer: ["Антикомунізм", "Націоналізм"] },
    { q: "Хто переміг у Громадянській війні в Іспанії?", answer: ["Націоналісти", "Франкісти", "Франко"] },
    { q: "Яка сусідня країна допомагала націоналістам технікою та військами?", answer: ["Португалія"] },
    { q: "Як називали польську політику тиску на українців у 30-х роках?", answer: ["Пацифікація"] },
    { q: "У якому місті відбувся прощальний парад Інтербригад у 1938 році?", answer: ["Барселона"] },
    { q: "Яку назву мала дивізія, де воювали деякі ветерани-франкісти після 1941 року?", answer: ["Блакитна", "Блакитна дивізія"] },
    { q: "Як називали іноземців, що воювали за Республіку?", answer: ["Інтербригади", "Добровольці"] }
  ];

  const $ = s => document.querySelector(s);
  const $$ = (s, root = document) => [...root.querySelectorAll(s)];
  const shuffle = a => { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]]; } return a; };
  const normalize = s => s.trim().toLowerCase();

  function split3(n) {
    const base = Math.floor(n / 3);
    const rem = n % 3;
    const parts = [base, base, base];
    const idx = [0, 1, 2];
    shuffle(idx);
    for (let i = 0; i < rem; i++) parts[idx[i]]++;
    return parts;
  }

  let currentQuiz = [];
  const pick = (bank, n) => shuffle([...bank]).slice(0, n);

  function generateQuiz() {
    const countEl = document.getElementById('count');
    const n = countEl ? (+countEl.value || 9) : 9;

    const [a, b, c] = split3(n);

    const partA = pick(BANK_SINGLE, a).map(it => {
      const mixed = it.choices.map((txt, i) => ({
        txt,
        isCorrect: i === it.answerIndex
      }));

      shuffle(mixed);

      return {
        type: 'A',
        q: it.q,
        choices: mixed.map(m => m.txt),
        answerIndex: mixed.findIndex(m => m.isCorrect)
      };
    });

    const partB = pick(BANK_MULTI, b).map(it => {
      let options = it.choices.map((txt, i) => ({
        text: txt,
        isCorrect: it.correct.includes(i)
      }));

      shuffle(options);

      return {
        type: 'B',
        q: it.q,
        choices: options.map(o => o.text),
        correct: options.reduce((acc, o, i) => (o.isCorrect ? acc.concat(i) : acc), [])
      };
    });

    const partC = pick(BANK_TEXT, c).map(it => ({ type: 'C', ...it }));

    currentQuiz = shuffle([...partA, ...partB, ...partC]);
    renderQuiz();

    checkBtn.disabled = false;
    resetBtn.disabled = false;
    document.getElementById('resultBox').textContent = '';
  }

  function renderQuiz() {
    const html = currentQuiz.map((it, qi) => {
      const body =
        it.type === 'A'
          ? it.choices.map((t, i) =>
            `<label class="choice">
                <input type="radio" name="q${qi}" value="${i}">
                <span class="opt-text">${t}</span>
              </label>`
          ).join('')
          : it.type === 'B'
            ? it.choices.map((t, i) =>
              `<label class="choice">
                <input type="checkbox" name="q${qi}" value="${i}">
                <span class="opt-text">${t}</span>
              </label>`
            ).join('')
            : `<input class="text-answer" type="text" name="q${qi}" placeholder="Введіть відповідь">`;

      return `<div class="question">
        <p class="q-title">${qi + 1}. ${it.q}</p>
        <div class="choices">${body}</div>
      </div>`;
    }).join('');

    quizRoot.innerHTML = html;
  }

  function checkAnswers() {
    $$('label.correct, label.incorrect, label.missed, input.text-answer.correct, input.text-answer.incorrect')
      .forEach(el => el.classList.remove('correct', 'incorrect', 'missed'));

    let score = 0;

    currentQuiz.forEach((it, qi) => {
      if (it.type === 'A') {
        const inputs = $$(`input[name="q${qi}"]`);
        const picked = inputs.find(i => i.checked);
        if (picked) {
          const v = +picked.value;
          if (v === it.answerIndex) {
            score++;
            picked.parentElement.classList.add('correct');
          } else {
            picked.parentElement.classList.add('incorrect');
            inputs[it.answerIndex]?.parentElement.classList.add('correct');
          }
        } else {
          inputs[it.answerIndex]?.parentElement.classList.add('missed');
        }
      }

      else if (it.type === 'B') {
        const inputs = $$(`input[name="q${qi}"]`);
        const selected = inputs.reduce((acc, i) => (i.checked ? acc.concat(+i.value) : acc), []);
        const correct = new Set(it.correct);

        const ok = selected.length === correct.size && selected.every(v => correct.has(v));

        inputs.forEach((inp, i) => {
          const lbl = inp.parentElement;
          const isCorrectAnswer = correct.has(i);
          const isSelected = inp.checked;

          if (isSelected && isCorrectAnswer) {
            lbl.classList.add('correct');
          } else if (isSelected && !isCorrectAnswer) {
            lbl.classList.add('incorrect');
          } else if (!isSelected && isCorrectAnswer) {
            lbl.classList.add('missed');
          }
        });

        if (ok) score++;
      }

      else if (it.type === 'C') {
        const inp = document.querySelector(`input[name="q${qi}"]`);
        const ok = it.answer.some(a => normalize(a) === normalize(inp.value));
        inp.classList.add(ok ? 'correct' : 'incorrect');
        if (ok) score++;
      }
    });

    const total = currentQuiz.length;
    const percent = Math.round((score / total) * 100);
    const msg =
      percent >= 90 ? 'Відмінно!' :
        percent >= 75 ? 'Добре!' :
          percent >= 50 ? 'Зараховано' : 'Спробуйте ще раз';

    const box = document.getElementById('resultBox');
    box.innerHTML = `Результат: <strong>${score} / ${total}</strong> (${percent}%). ${msg}`;
    box.style.color = percent >= 60 ? 'var(--ok)' : 'var(--bad)';
  }

  function resetQuiz() {
    currentQuiz = [];
    quizRoot.innerHTML = '';
    document.getElementById('resultBox').textContent = '';
    checkBtn.disabled = true;
    resetBtn.disabled = true;
  }

  genBtn.addEventListener('click', generateQuiz);
  checkBtn.addEventListener('click', checkAnswers);
  resetBtn.addEventListener('click', resetQuiz);
})();